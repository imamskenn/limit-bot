import makeWASocket, {
  DisconnectReason,
  fetchLatestBaileysVersion,
  useMultiFileAuthState
} from '@whiskeysockets/baileys'
import qrcode from 'qrcode-terminal'
import P from 'pino'

// ===================== CONFIG =====================

// Mapping nama grup â†’ kode R/N atau khusus L
const GROUP_CODES = {
  'pengcm333(604)(n207)': { R: 604, N: 207 },
  'wpcm48/(102)': { R: 102 },
  'wpcm127/rylc050206': { R: 206 },
  'wp3388/050203': { R: 203 },
  '234-1(675)': { R: 675 },
  '333(050309)': { R: 309 },
  'klangfila88 (631)': { R: 631 },
  'bktflat33 (638)': { R: 638 },
  'clfcm33(637)': { R: 637 },
  'nbc3888(688)(n203)ðŸŒŸ': { R: 688, N: 203 },

  // grup biasa (khusus L)
  'bkt2888 (629)': { L: true },
  'tamankem888': { L: true },
  'tp208': { L: true },
  'by27cm': { L: true },
  'bt-1a': { L: true },
  'bkth502': { L: true },
  'bn26': { L: true },
  'pj27cm': { L: true },
  'flat12cm': { L: true },
  'bayu310cm': { L: true },
  'bkt25cm': { L: true },
  'tclcm': { L: true },
  'pj31cm': { L: true },
  'stcm88': { L: true }
}

// JID grup Limit Centre
const LIMIT_GROUP_JID = '120363406990741857@g.us'

// ==================================================

// Cache metadata grup
const groupCache = {}
async function getGroupName(jid, sock) {
  if (groupCache[jid]) return groupCache[jid]
  const metadata = await sock.groupMetadata(jid)
  groupCache[jid] = metadata.subject
  return groupCache[jid]
}

// Emoji kategori
function getEmoji(line) {
  if (line.startsWith('M+')) return 'ðŸŸ¨'
  if (line.startsWith('R+')) return 'ðŸŸ¦'
  if (line.startsWith('N+')) return 'ðŸŸ©'
  if (line.startsWith('L+')) return 'â¬œ'
  if (line.startsWith('K+')) return 'ðŸŸª'
  return ''
}

async function startBot() {
  const { state, saveCreds } = await useMultiFileAuthState('./auth_info_bot')
  const { version } = await fetchLatestBaileysVersion()
  const sock = makeWASocket({
    auth: state,
    version,
    logger: P({ level: 'silent' })
  })

  // Handle koneksi
  sock.ev.on('connection.update', update => {
    const { connection, lastDisconnect, qr } = update
    if (qr) qrcode.generate(qr, { small: true })
    if (connection === 'open') console.log('âœ… Bot connected')
    if (connection === 'close') {
      const code = lastDisconnect?.error?.output?.statusCode
      console.log('âŒ Disconnected', code)
      if (code !== DisconnectReason.loggedOut) startBot()
    }
  })

  // Pesan Group
  sock.ev.on('messages.upsert', async ({ messages }) => {
    for (let m of messages) {
      if (!m.message || m.key.fromMe) continue

      const jid = m.key.remoteJid
      const text = m.message.conversation || m.message.extendedTextMessage?.text
      if (!text) continue

      // Ambil nama grup dari cache
      const groupName = await getGroupName(jid, sock)
      const cleanName = groupName.split('(')[0].trim().toLowerCase()
      const groupData = GROUP_CODES[cleanName]
      if (!groupData) continue

      // Deteksi hanya satu baris
      const lines = text.trim().split('\n')
      if (lines.length !== 1) continue

      // Normalisasi ke uppercase
      const line = lines[0].trim().toUpperCase()
      if (!/^[MRNLK][+-]\s*(\d+K?|\d+)$/.test(line)) continue

      let sendText = ''
      if (line.startsWith('M')) {
        sendText = `${cleanName} ${line}`
      } else if (line.startsWith('R') && groupData.R) {
        sendText = `${groupData.R} ${line}`
      } else if (line.startsWith('N') && groupData.N) {
        sendText = `${groupData.N} ${line}`
      } else if (line.startsWith('L') && groupData.L) {
        sendText = `${cleanName} ${line}`
      } else if (line.startsWith('K')) {
        sendText = `${cleanName} ${line}`
      }

     if (sendText) {
  // forward ke Limit Centre full CAPSLOCK
  await sock.sendMessage(LIMIT_GROUP_JID, { text: sendText.toUpperCase() })

  // log juga full CAPSLOCK
  const now = new Date()
  const jam = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
  const emoji = getEmoji(line.toUpperCase())
  console.log(`${emoji} ${jam} | ${cleanName.toUpperCase()} | ${line.toUpperCase()} |`)
}
    }
  })
}

startBot()
